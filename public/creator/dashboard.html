<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creator Dashboard</title>

<style>
body{margin:0;font-family:Arial;background:#111;color:white;padding:30px;}
h2{margin-bottom:10px;}
button{background:red;color:white;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;margin:5px;}
input{margin:10px 0;color:white;}
.loop{border:1px solid #333;padding:15px;border-radius:10px;margin-top:20px;}
video{width:100%;max-width:400px;border-radius:10px;margin-top:10px;}
</style>
</head>
<body>

<h2 id="welcome"></h2>

<input type="file" id="videoFile" accept="video/mp4">
<br>
<button onclick="uploadLoop()">Upload loop</button>
<button onclick="logout()">Logout</button>

<div id="loops"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabaseJs.createClient(
  "https://uurmdzzmzwumjtanlcvz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1cm1kenptend1bWp0YW5sY3Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MDkwNDcsImV4cCI6MjA4MTI4NTA0N30.mVQKqbk0IZbXLrWMOvOqiB9OSHJgk09Wg0DsIJs0mhA"
);

let currentUser = null;

// 1️⃣ Comprobar sesión
async function checkAuth(){
  const { data:{user} } = await supabase.auth.getUser();
  if(!user){ window.location.href="index.html"; return; }
  currentUser = user;
  document.getElementById("welcome").innerText = "Welcome " + user.email;
  loadLoops();
}
checkAuth();

// 2️⃣ Subir loop
async function uploadLoop(){
  const file = document.getElementById("videoFile").files[0];
  if(!file){ alert("Select mp4"); return; }

  const filePath = `${currentUser.email}/${Date.now()}_${file.name}`;

  const { error:uploadError } = await supabase
    .storage.from("loops")
    .upload(filePath,file,{upsert:true});

  if(uploadError){ alert("Upload error"); console.error(uploadError); return; }

  const { data } = supabase.storage.from("loops").getPublicUrl(filePath);

  await supabase.from("loops").insert({
    owner: currentUser.email,
    name: file.name,
    video_url: data.publicUrl,
    active: true
  });

  loadLoops();
}

// 3️⃣ Cargar loops del creador
async function loadLoops(){
  const { data } = await supabase
    .from("loops")
    .select("*")
    .eq("owner", currentUser.email)
    .order("created_at",{ascending:false});

  const container = document.getElementById("loops");
  container.innerHTML = "";

  if(!data || data.length===0){
    container.innerHTML="<p>No loops yet
