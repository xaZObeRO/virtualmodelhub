<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creator Dashboard</title>
<style>
body{font-family:Arial;background:#111;color:white;padding:20px;}
input,button{padding:10px 15px;margin:5px;border:none;border-radius:5px;cursor:pointer;}
button{background:red;color:white;}
.loop-item{border:1px solid #333;padding:10px;margin:10px 0;border-radius:5px;display:flex;flex-direction:column;align-items:flex-start;}
.loop-controls{display:flex;justify-content:flex-start;gap:10px;margin-top:5px;}
video{max-width:400px;border-radius:5px;margin-bottom:5px;}
.tip-btn{background:#ff2d55;color:white;border:none;padding:8px 15px;border-radius:20px;cursor:pointer;}
.tip-btn:hover{background:#d11b3c;}
.other-loop{opacity:0.5;}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "TU_SUPABASE_URL";
const SUPABASE_ANON_KEY = "TU_ANON_PUBLIC_KEY";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let user = null;

async function init(){
    const { data: { user: currentUser } } = await supabase.auth.getUser();
    if(!currentUser){ window.location.href="index.html"; return; }
    user = currentUser;
    document.getElementById('userEmail').innerText = user.email;
    loadLoops();
}

async function loadLoops(){
    let { data: myLoops } = await supabase.from('loops').select('*').eq('owner', user.id).order('created_at',{ascending:false});
    let { data: otherLoops } = await supabase.from('loops').select('*').neq('owner', user.id).order('created_at',{ascending:false});
    renderLoops(myLoops, otherLoops);
}

function renderLoops(myLoops, otherLoops){
    let container = document.getElementById('loopsContainer');
    let otherContainer = document.getElementById('otherLoopsContainer');
    container.innerHTML = ""; otherContainer.innerHTML = "";

    myLoops.forEach(loop => createLoopDiv(loop, true, container));
    otherLoops.forEach(loop => createLoopDiv(loop, false, otherContainer));
}

function createLoopDiv(loop, isOwner, container){
    let div = document.createElement('div'); 
    div.className = "loop-item";
    if(!isOwner) div.classList.add('other-loop');

    let videoEl = document.createElement('video');
    videoEl.src = loop.url;
    videoEl.controls = true;
    videoEl.loop = true;

    let info = document.createElement('div');
    info.innerText = `${loop.name} (${loop.duration}s) - ${loop.active?"Active":"Inactive"}`;
    div.appendChild(videoEl);
    div.appendChild(info);

    if(isOwner){
        let controls = document.createElement('div'); controls.className="loop-controls";

        let toggleBtn = document.createElement('button');
        toggleBtn.innerText = loop.active?"Deactivate":"Activate";
        toggleBtn.onclick = async ()=>{
            await supabase.from('loops').update({active:!loop.active}).eq('id',loop.id);
            loadLoops();
        };

        let deleteBtn = document.createElement('button');
        deleteBtn.innerText = "Delete";
        deleteBtn.onclick = async ()=>{
            await supabase.from('loops').delete().eq('id',loop.id);
            await supabase.storage.from('loops').remove([`${user.id}/${loop.name}`]);
            loadLoops();
        };

        let tipBtn = document.createElement('button');
        tipBtn.className = "tip-btn";
        tipBtn.innerText = "❤️ Tip this loop";
        tipBtn.onclick = ()=>{ window.open("https://TU-LINK-DE-PAGO-AQUI",'_blank'); };

        controls.appendChild(toggleBtn);
        controls.appendChild(deleteBtn);
        controls.appendChild(tipBtn);
        div.appendChild(controls);
    }

    container.appendChild(div);
}

async function uploadLoop(){
    let file = document.getElementById('videoFile').files[0];
    if(!file){ alert("Select mp4"); return; }

    const { data, error } = await supabase.storage.from('loops').upload(`${user.id}/${file.name}`, file, { upsert:true });
    if(error){ alert(error.message); return; }

    const { data: urlData } = supabase.storage.from('loops').getPublicUrl(`${user.id}/${file.name}`);
    await supabase.from('loops').insert({
        owner: user.id,
        name: file.name,
        duration: Math.floor(file.size/1000000*10),
        active: true,
        url: urlData.publicUrl
    });
    loadLoops();
}
</script>
</head>
<body onload="init()">
<h2>Welcome, <span id="userEmail"></span></h2>
<input type="file" id="videoFile" accept="video/mp4">
<button onclick="uploadLoop()">Upload Loop</button>

<h3>Your Loops</h3>
<div id="loopsContainer"></div>

<h3>Other Creators Loops</h3>
<div id="otherLoopsContainer"></div>
</body>
</html>
